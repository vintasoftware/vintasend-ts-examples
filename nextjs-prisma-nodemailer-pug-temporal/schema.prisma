datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-1.1.x"]
}

model User {
  id              Int            @id @default(autoincrement())
  email           String         @unique
  password        String
  firstName       String?
  lastName        String?
  isEmailVerified Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  tokens          Token[]
  roles           Role[]         @relation("UserToRole")
  permissions     Permission[]   @relation("UserToPermission")
  Notification    Notification[]
}

model Token {
  id        Int       @id @default(autoincrement())
  token     String    @unique
  type      TokenType
  expiresAt DateTime
  createdAt DateTime  @default(now())
  userId    Int
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Permission {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  users       User[]   @relation("UserToPermission")
  roles       Role[]   @relation("RoleToPermission")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  users       User[]       @relation("UserToRole")
  permissions Permission[] @relation("RoleToPermission")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

model Notification {
  id                     Int                        @id @default(autoincrement())
  // For regular notifications (optional now)
  userId                 Int?
  user                   User?                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  // For one-off notifications (optional - used when userId is null)
  emailOrPhone           String?
  firstName              String?
  lastName               String?
  // Common fields
  notificationType       NotificationType
  title                  String?
  bodyTemplate           String
  contextName            String
  contextParameters      Json                       @default("{}")
  sendAfter              DateTime?
  subjectTemplate        String?
  extraParams            Json?
  status                 NotificationStatus         @default(PENDING_SEND)
  contextUsed            Json?
  adapterUsed            String?
  gitCommitSha           String?
  sentAt                 DateTime?
  readAt                 DateTime?
  createdAt              DateTime                   @default(now())
  updatedAt              DateTime                   @updatedAt
  // Attachments
  attachments            NotificationAttachment[]

  @@index([status, sendAfter])
  @@index([userId])
  @@index([emailOrPhone])
  @@index([gitCommitSha])
}

// Reusable attachment files (stored once, referenced many times)
model AttachmentFile {
  id                     String                     @id @default(uuid())
  filename               String
  contentType            String
  size                   Int
  checksum               String                     @unique
  storageMetadata        Json
  createdAt              DateTime                   @default(now())
  updatedAt              DateTime                   @updatedAt
  notificationAttachments NotificationAttachment[]
  
  @@index([checksum])
}

// Join table linking notifications to attachment files
model NotificationAttachment {
  id             String         @id @default(uuid())
  notificationId Int
  notification   Notification   @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  fileId         String
  attachmentFile AttachmentFile @relation(fields: [fileId], references: [id], onDelete: Restrict)
  description    String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([notificationId, fileId])
  @@index([notificationId])
  @@index([fileId])
}

enum NotificationType {
  EMAIL
  PUSH
  SMS
  IN_APP
}

enum NotificationStatus {
  PENDING_SEND
  SENT
  FAILED
  READ
  CANCELLED
}
